revoke delete on table "public"."account_deletion_requests" from "anon";

revoke insert on table "public"."account_deletion_requests" from "anon";

revoke references on table "public"."account_deletion_requests" from "anon";

revoke select on table "public"."account_deletion_requests" from "anon";

revoke trigger on table "public"."account_deletion_requests" from "anon";

revoke truncate on table "public"."account_deletion_requests" from "anon";

revoke update on table "public"."account_deletion_requests" from "anon";

revoke delete on table "public"."account_deletion_requests" from "authenticated";

revoke insert on table "public"."account_deletion_requests" from "authenticated";

revoke references on table "public"."account_deletion_requests" from "authenticated";

revoke select on table "public"."account_deletion_requests" from "authenticated";

revoke trigger on table "public"."account_deletion_requests" from "authenticated";

revoke truncate on table "public"."account_deletion_requests" from "authenticated";

revoke update on table "public"."account_deletion_requests" from "authenticated";

revoke delete on table "public"."account_deletion_requests" from "service_role";

revoke insert on table "public"."account_deletion_requests" from "service_role";

revoke references on table "public"."account_deletion_requests" from "service_role";

revoke select on table "public"."account_deletion_requests" from "service_role";

revoke trigger on table "public"."account_deletion_requests" from "service_role";

revoke truncate on table "public"."account_deletion_requests" from "service_role";

revoke update on table "public"."account_deletion_requests" from "service_role";

revoke delete on table "public"."availability" from "anon";

revoke insert on table "public"."availability" from "anon";

revoke references on table "public"."availability" from "anon";

revoke select on table "public"."availability" from "anon";

revoke trigger on table "public"."availability" from "anon";

revoke truncate on table "public"."availability" from "anon";

revoke update on table "public"."availability" from "anon";

revoke delete on table "public"."availability" from "authenticated";

revoke insert on table "public"."availability" from "authenticated";

revoke references on table "public"."availability" from "authenticated";

revoke select on table "public"."availability" from "authenticated";

revoke trigger on table "public"."availability" from "authenticated";

revoke truncate on table "public"."availability" from "authenticated";

revoke update on table "public"."availability" from "authenticated";

revoke delete on table "public"."availability" from "service_role";

revoke insert on table "public"."availability" from "service_role";

revoke references on table "public"."availability" from "service_role";

revoke select on table "public"."availability" from "service_role";

revoke trigger on table "public"."availability" from "service_role";

revoke truncate on table "public"."availability" from "service_role";

revoke update on table "public"."availability" from "service_role";

revoke delete on table "public"."conversations" from "anon";

revoke insert on table "public"."conversations" from "anon";

revoke references on table "public"."conversations" from "anon";

revoke select on table "public"."conversations" from "anon";

revoke trigger on table "public"."conversations" from "anon";

revoke truncate on table "public"."conversations" from "anon";

revoke update on table "public"."conversations" from "anon";

revoke delete on table "public"."conversations" from "authenticated";

revoke insert on table "public"."conversations" from "authenticated";

revoke references on table "public"."conversations" from "authenticated";

revoke select on table "public"."conversations" from "authenticated";

revoke trigger on table "public"."conversations" from "authenticated";

revoke truncate on table "public"."conversations" from "authenticated";

revoke update on table "public"."conversations" from "authenticated";

revoke delete on table "public"."conversations" from "service_role";

revoke insert on table "public"."conversations" from "service_role";

revoke references on table "public"."conversations" from "service_role";

revoke select on table "public"."conversations" from "service_role";

revoke trigger on table "public"."conversations" from "service_role";

revoke truncate on table "public"."conversations" from "service_role";

revoke update on table "public"."conversations" from "service_role";

revoke delete on table "public"."dogs" from "anon";

revoke insert on table "public"."dogs" from "anon";

revoke references on table "public"."dogs" from "anon";

revoke select on table "public"."dogs" from "anon";

revoke trigger on table "public"."dogs" from "anon";

revoke truncate on table "public"."dogs" from "anon";

revoke update on table "public"."dogs" from "anon";

revoke delete on table "public"."dogs" from "authenticated";

revoke insert on table "public"."dogs" from "authenticated";

revoke references on table "public"."dogs" from "authenticated";

revoke select on table "public"."dogs" from "authenticated";

revoke trigger on table "public"."dogs" from "authenticated";

revoke truncate on table "public"."dogs" from "authenticated";

revoke update on table "public"."dogs" from "authenticated";

revoke delete on table "public"."dogs" from "service_role";

revoke insert on table "public"."dogs" from "service_role";

revoke references on table "public"."dogs" from "service_role";

revoke select on table "public"."dogs" from "service_role";

revoke trigger on table "public"."dogs" from "service_role";

revoke truncate on table "public"."dogs" from "service_role";

revoke update on table "public"."dogs" from "service_role";

revoke delete on table "public"."email_catalog" from "anon";

revoke insert on table "public"."email_catalog" from "anon";

revoke references on table "public"."email_catalog" from "anon";

revoke select on table "public"."email_catalog" from "anon";

revoke trigger on table "public"."email_catalog" from "anon";

revoke truncate on table "public"."email_catalog" from "anon";

revoke update on table "public"."email_catalog" from "anon";

revoke delete on table "public"."email_catalog" from "authenticated";

revoke insert on table "public"."email_catalog" from "authenticated";

revoke references on table "public"."email_catalog" from "authenticated";

revoke select on table "public"."email_catalog" from "authenticated";

revoke trigger on table "public"."email_catalog" from "authenticated";

revoke truncate on table "public"."email_catalog" from "authenticated";

revoke update on table "public"."email_catalog" from "authenticated";

revoke delete on table "public"."email_catalog" from "service_role";

revoke insert on table "public"."email_catalog" from "service_role";

revoke references on table "public"."email_catalog" from "service_role";

revoke select on table "public"."email_catalog" from "service_role";

revoke trigger on table "public"."email_catalog" from "service_role";

revoke truncate on table "public"."email_catalog" from "service_role";

revoke update on table "public"."email_catalog" from "service_role";

revoke delete on table "public"."email_events" from "anon";

revoke insert on table "public"."email_events" from "anon";

revoke references on table "public"."email_events" from "anon";

revoke select on table "public"."email_events" from "anon";

revoke trigger on table "public"."email_events" from "anon";

revoke truncate on table "public"."email_events" from "anon";

revoke update on table "public"."email_events" from "anon";

revoke delete on table "public"."email_events" from "authenticated";

revoke insert on table "public"."email_events" from "authenticated";

revoke references on table "public"."email_events" from "authenticated";

revoke select on table "public"."email_events" from "authenticated";

revoke trigger on table "public"."email_events" from "authenticated";

revoke truncate on table "public"."email_events" from "authenticated";

revoke update on table "public"."email_events" from "authenticated";

revoke delete on table "public"."email_events" from "service_role";

revoke insert on table "public"."email_events" from "service_role";

revoke references on table "public"."email_events" from "service_role";

revoke select on table "public"."email_events" from "service_role";

revoke trigger on table "public"."email_events" from "service_role";

revoke truncate on table "public"."email_events" from "service_role";

revoke update on table "public"."email_events" from "service_role";

revoke delete on table "public"."meetings" from "anon";

revoke insert on table "public"."meetings" from "anon";

revoke references on table "public"."meetings" from "anon";

revoke select on table "public"."meetings" from "anon";

revoke trigger on table "public"."meetings" from "anon";

revoke truncate on table "public"."meetings" from "anon";

revoke update on table "public"."meetings" from "anon";

revoke delete on table "public"."meetings" from "authenticated";

revoke insert on table "public"."meetings" from "authenticated";

revoke references on table "public"."meetings" from "authenticated";

revoke select on table "public"."meetings" from "authenticated";

revoke trigger on table "public"."meetings" from "authenticated";

revoke truncate on table "public"."meetings" from "authenticated";

revoke update on table "public"."meetings" from "authenticated";

revoke delete on table "public"."meetings" from "service_role";

revoke insert on table "public"."meetings" from "service_role";

revoke references on table "public"."meetings" from "service_role";

revoke select on table "public"."meetings" from "service_role";

revoke trigger on table "public"."meetings" from "service_role";

revoke truncate on table "public"."meetings" from "service_role";

revoke update on table "public"."meetings" from "service_role";

revoke delete on table "public"."messages" from "anon";

revoke insert on table "public"."messages" from "anon";

revoke references on table "public"."messages" from "anon";

revoke select on table "public"."messages" from "anon";

revoke trigger on table "public"."messages" from "anon";

revoke truncate on table "public"."messages" from "anon";

revoke update on table "public"."messages" from "anon";

revoke delete on table "public"."messages" from "authenticated";

revoke insert on table "public"."messages" from "authenticated";

revoke references on table "public"."messages" from "authenticated";

revoke select on table "public"."messages" from "authenticated";

revoke trigger on table "public"."messages" from "authenticated";

revoke truncate on table "public"."messages" from "authenticated";

revoke update on table "public"."messages" from "authenticated";

revoke delete on table "public"."messages" from "service_role";

revoke insert on table "public"."messages" from "service_role";

revoke references on table "public"."messages" from "service_role";

revoke select on table "public"."messages" from "service_role";

revoke trigger on table "public"."messages" from "service_role";

revoke truncate on table "public"."messages" from "service_role";

revoke update on table "public"."messages" from "service_role";

revoke delete on table "public"."profile_views" from "anon";

revoke insert on table "public"."profile_views" from "anon";

revoke references on table "public"."profile_views" from "anon";

revoke select on table "public"."profile_views" from "anon";

revoke trigger on table "public"."profile_views" from "anon";

revoke truncate on table "public"."profile_views" from "anon";

revoke update on table "public"."profile_views" from "anon";

revoke delete on table "public"."profile_views" from "authenticated";

revoke insert on table "public"."profile_views" from "authenticated";

revoke references on table "public"."profile_views" from "authenticated";

revoke select on table "public"."profile_views" from "authenticated";

revoke trigger on table "public"."profile_views" from "authenticated";

revoke truncate on table "public"."profile_views" from "authenticated";

revoke update on table "public"."profile_views" from "authenticated";

revoke delete on table "public"."profile_views" from "service_role";

revoke insert on table "public"."profile_views" from "service_role";

revoke references on table "public"."profile_views" from "service_role";

revoke select on table "public"."profile_views" from "service_role";

revoke trigger on table "public"."profile_views" from "service_role";

revoke truncate on table "public"."profile_views" from "service_role";

revoke update on table "public"."profile_views" from "service_role";

revoke delete on table "public"."profiles" from "anon";

revoke insert on table "public"."profiles" from "anon";

revoke references on table "public"."profiles" from "anon";

revoke select on table "public"."profiles" from "anon";

revoke trigger on table "public"."profiles" from "anon";

revoke truncate on table "public"."profiles" from "anon";

revoke update on table "public"."profiles" from "anon";

revoke delete on table "public"."profiles" from "authenticated";

revoke insert on table "public"."profiles" from "authenticated";

revoke references on table "public"."profiles" from "authenticated";

revoke select on table "public"."profiles" from "authenticated";

revoke trigger on table "public"."profiles" from "authenticated";

revoke truncate on table "public"."profiles" from "authenticated";

revoke update on table "public"."profiles" from "authenticated";

revoke delete on table "public"."profiles" from "service_role";

revoke insert on table "public"."profiles" from "service_role";

revoke references on table "public"."profiles" from "service_role";

revoke select on table "public"."profiles" from "service_role";

revoke trigger on table "public"."profiles" from "service_role";

revoke truncate on table "public"."profiles" from "service_role";

revoke update on table "public"."profiles" from "service_role";

revoke delete on table "public"."reviews" from "anon";

revoke insert on table "public"."reviews" from "anon";

revoke references on table "public"."reviews" from "anon";

revoke select on table "public"."reviews" from "anon";

revoke trigger on table "public"."reviews" from "anon";

revoke truncate on table "public"."reviews" from "anon";

revoke update on table "public"."reviews" from "anon";

revoke delete on table "public"."reviews" from "authenticated";

revoke insert on table "public"."reviews" from "authenticated";

revoke references on table "public"."reviews" from "authenticated";

revoke select on table "public"."reviews" from "authenticated";

revoke trigger on table "public"."reviews" from "authenticated";

revoke truncate on table "public"."reviews" from "authenticated";

revoke update on table "public"."reviews" from "authenticated";

revoke delete on table "public"."reviews" from "service_role";

revoke insert on table "public"."reviews" from "service_role";

revoke references on table "public"."reviews" from "service_role";

revoke select on table "public"."reviews" from "service_role";

revoke trigger on table "public"."reviews" from "service_role";

revoke truncate on table "public"."reviews" from "service_role";

revoke update on table "public"."reviews" from "service_role";

revoke delete on table "public"."reviews_pending" from "anon";

revoke insert on table "public"."reviews_pending" from "anon";

revoke references on table "public"."reviews_pending" from "anon";

revoke select on table "public"."reviews_pending" from "anon";

revoke trigger on table "public"."reviews_pending" from "anon";

revoke truncate on table "public"."reviews_pending" from "anon";

revoke update on table "public"."reviews_pending" from "anon";

revoke delete on table "public"."reviews_pending" from "authenticated";

revoke insert on table "public"."reviews_pending" from "authenticated";

revoke references on table "public"."reviews_pending" from "authenticated";

revoke select on table "public"."reviews_pending" from "authenticated";

revoke trigger on table "public"."reviews_pending" from "authenticated";

revoke truncate on table "public"."reviews_pending" from "authenticated";

revoke update on table "public"."reviews_pending" from "authenticated";

revoke delete on table "public"."reviews_pending" from "service_role";

revoke insert on table "public"."reviews_pending" from "service_role";

revoke references on table "public"."reviews_pending" from "service_role";

revoke select on table "public"."reviews_pending" from "service_role";

revoke trigger on table "public"."reviews_pending" from "service_role";

revoke truncate on table "public"."reviews_pending" from "service_role";

revoke update on table "public"."reviews_pending" from "service_role";

revoke delete on table "public"."scheduled_emails" from "anon";

revoke insert on table "public"."scheduled_emails" from "anon";

revoke references on table "public"."scheduled_emails" from "anon";

revoke select on table "public"."scheduled_emails" from "anon";

revoke trigger on table "public"."scheduled_emails" from "anon";

revoke truncate on table "public"."scheduled_emails" from "anon";

revoke update on table "public"."scheduled_emails" from "anon";

revoke delete on table "public"."scheduled_emails" from "authenticated";

revoke insert on table "public"."scheduled_emails" from "authenticated";

revoke references on table "public"."scheduled_emails" from "authenticated";

revoke select on table "public"."scheduled_emails" from "authenticated";

revoke trigger on table "public"."scheduled_emails" from "authenticated";

revoke truncate on table "public"."scheduled_emails" from "authenticated";

revoke update on table "public"."scheduled_emails" from "authenticated";

revoke delete on table "public"."scheduled_emails" from "service_role";

revoke insert on table "public"."scheduled_emails" from "service_role";

revoke references on table "public"."scheduled_emails" from "service_role";

revoke select on table "public"."scheduled_emails" from "service_role";

revoke trigger on table "public"."scheduled_emails" from "service_role";

revoke truncate on table "public"."scheduled_emails" from "service_role";

revoke update on table "public"."scheduled_emails" from "service_role";

revoke delete on table "public"."user_activity" from "anon";

revoke insert on table "public"."user_activity" from "anon";

revoke references on table "public"."user_activity" from "anon";

revoke select on table "public"."user_activity" from "anon";

revoke trigger on table "public"."user_activity" from "anon";

revoke truncate on table "public"."user_activity" from "anon";

revoke update on table "public"."user_activity" from "anon";

revoke delete on table "public"."user_activity" from "authenticated";

revoke insert on table "public"."user_activity" from "authenticated";

revoke references on table "public"."user_activity" from "authenticated";

revoke select on table "public"."user_activity" from "authenticated";

revoke trigger on table "public"."user_activity" from "authenticated";

revoke truncate on table "public"."user_activity" from "authenticated";

revoke update on table "public"."user_activity" from "authenticated";

revoke delete on table "public"."user_activity" from "service_role";

revoke insert on table "public"."user_activity" from "service_role";

revoke references on table "public"."user_activity" from "service_role";

revoke select on table "public"."user_activity" from "service_role";

revoke trigger on table "public"."user_activity" from "service_role";

revoke truncate on table "public"."user_activity" from "service_role";

revoke update on table "public"."user_activity" from "service_role";

revoke delete on table "public"."user_settings" from "anon";

revoke insert on table "public"."user_settings" from "anon";

revoke references on table "public"."user_settings" from "anon";

revoke select on table "public"."user_settings" from "anon";

revoke trigger on table "public"."user_settings" from "anon";

revoke truncate on table "public"."user_settings" from "anon";

revoke update on table "public"."user_settings" from "anon";

revoke delete on table "public"."user_settings" from "authenticated";

revoke insert on table "public"."user_settings" from "authenticated";

revoke references on table "public"."user_settings" from "authenticated";

revoke select on table "public"."user_settings" from "authenticated";

revoke trigger on table "public"."user_settings" from "authenticated";

revoke truncate on table "public"."user_settings" from "authenticated";

revoke update on table "public"."user_settings" from "authenticated";

revoke delete on table "public"."user_settings" from "service_role";

revoke insert on table "public"."user_settings" from "service_role";

revoke references on table "public"."user_settings" from "service_role";

revoke select on table "public"."user_settings" from "service_role";

revoke trigger on table "public"."user_settings" from "service_role";

revoke truncate on table "public"."user_settings" from "service_role";

revoke update on table "public"."user_settings" from "service_role";

set check_function_bodies = off;

CREATE OR REPLACE FUNCTION public.check_review_needed()
 RETURNS trigger
 LANGUAGE plpgsql
 SECURITY DEFINER
AS $function$
DECLARE
  days_old INTEGER;
  other_participant_id UUID;
  current_user_role TEXT;
  other_user_role TEXT;
  availability_post_type TEXT;
BEGIN
  -- Only check for new messages, not updates
  IF TG_OP = 'UPDATE' THEN
    RETURN NEW;
  END IF;
  
  -- Get days since last message in this conversation
  SELECT EXTRACT(DAY FROM (NOW() - c.last_message_at))::INTEGER
  INTO days_old
  FROM conversations c
  WHERE c.id = NEW.conversation_id;
  
  -- If conversation is older than 7 days, check if reviews are needed
  IF days_old >= 7 THEN
    -- Get the other participant
    SELECT 
      CASE 
        WHEN c.participant1_id = NEW.sender_id THEN c.participant2_id
        ELSE c.participant1_id
      END,
      CASE 
        WHEN c.participant1_id = NEW.sender_id THEN c.participant2_id
        ELSE c.participant1_id
      END
    INTO other_participant_id, other_participant_id
    FROM conversations c
    WHERE c.id = NEW.conversation_id;
    
    -- Get availability post type to determine roles
    SELECT a.post_type
    INTO availability_post_type
    FROM availability a
    WHERE a.id = NEW.availability_id;
    
    -- Determine roles based on post type
    IF availability_post_type = 'dog_available' THEN
      current_user_role := 'walker';
      other_user_role := 'owner';
    ELSE
      current_user_role := 'owner';
      other_user_role := 'walker';
    END IF;
    
    -- Check if review already exists for this user and conversation
    IF NOT EXISTS (
      SELECT 1 FROM reviews 
      WHERE reviewer_id = NEW.sender_id 
        AND conversation_id = NEW.conversation_id
    ) THEN
      -- Insert pending review for sender
      INSERT INTO reviews_pending (
        user_id, 
        conversation_id, 
        other_participant_id, 
        availability_id, 
        role, 
        other_role, 
        days_since_last_message
      ) VALUES (
        NEW.sender_id,
        NEW.conversation_id,
        other_participant_id,
        NEW.availability_id,
        current_user_role,
        other_user_role,
        days_old
      )
      ON CONFLICT (user_id, conversation_id) 
      DO UPDATE SET 
        days_since_last_message = days_old,
        updated_at = NOW();
    END IF;
    
    -- Check if review already exists for the other participant
    IF NOT EXISTS (
      SELECT 1 FROM reviews 
      WHERE reviewer_id = other_participant_id 
        AND conversation_id = NEW.conversation_id
    ) THEN
      -- Insert pending review for other participant
      INSERT INTO reviews_pending (
        user_id, 
        conversation_id, 
        other_participant_id, 
        availability_id, 
        role, 
        other_role, 
        days_since_last_message
      ) VALUES (
        other_participant_id,
        NEW.conversation_id,
        NEW.sender_id,
        NEW.availability_id,
        other_user_role,
        current_user_role,
        days_old
      )
      ON CONFLICT (user_id, conversation_id) 
      DO UPDATE SET 
        days_since_last_message = days_old,
        updated_at = NOW();
    END IF;
  END IF;
  
  RETURN NEW;
END;
$function$
;

CREATE OR REPLACE FUNCTION public.cleanup_pending_review()
 RETURNS trigger
 LANGUAGE plpgsql
 SECURITY DEFINER
AS $function$
BEGIN
  -- Remove pending review for the reviewer
  DELETE FROM reviews_pending 
  WHERE user_id = NEW.reviewer_id 
    AND conversation_id = NEW.conversation_id;
  
  RETURN NEW;
END;
$function$
;

CREATE OR REPLACE FUNCTION public.count_words(text_input text)
 RETURNS integer
 LANGUAGE plpgsql
AS $function$
BEGIN
  IF text_input IS NULL OR trim(text_input) = '' THEN
    RETURN 0;
  END IF;
  RETURN array_length(string_to_array(trim(text_input), ' '), 1);
END;
$function$
;

CREATE OR REPLACE FUNCTION public.create_user_settings_on_profile_insert()
 RETURNS trigger
 LANGUAGE plpgsql
AS $function$
BEGIN
  INSERT INTO user_settings (user_id, email_notifications, follow_up_email_sent)
  VALUES (NEW.id, true, false);
  RETURN NEW;
END;
$function$
;

CREATE OR REPLACE FUNCTION public.get_pending_reviews_for_user(user_id uuid)
 RETURNS TABLE(meeting_id uuid, meeting_title text, other_participant_id uuid, other_participant_name text, meeting_end_datetime timestamp with time zone)
 LANGUAGE plpgsql
AS $function$
BEGIN
  RETURN QUERY
  SELECT 
    m.id as meeting_id,
    m.title as meeting_title,
    CASE 
      WHEN m.requester_id = user_id THEN m.recipient_id
      ELSE m.requester_id
    END as other_participant_id,
    CASE 
      WHEN m.requester_id = user_id THEN COALESCE(p_recipient.first_name || ' ' || p_recipient.last_name, p_recipient.email)
      ELSE COALESCE(p_requester.first_name || ' ' || p_requester.last_name, p_requester.email)
    END as other_participant_name,
    m.end_datetime as meeting_end_datetime
  FROM meetings m
  LEFT JOIN profiles p_requester ON m.requester_id = p_requester.id
  LEFT JOIN profiles p_recipient ON m.recipient_id = p_recipient.id
  WHERE m.status = 'completed'
    AND (m.requester_id = user_id OR m.recipient_id = user_id)
    AND m.end_datetime < NOW()  -- Removed 24-hour delay
    AND NOT EXISTS (
      SELECT 1 FROM reviews r 
      WHERE r.meeting_id = m.id 
      AND r.reviewer_id = user_id
    );
END;
$function$
;

CREATE OR REPLACE FUNCTION public.get_user_average_rating(user_id uuid)
 RETURNS numeric
 LANGUAGE plpgsql
AS $function$
DECLARE
  avg_rating DECIMAL;
BEGIN
  SELECT COALESCE(AVG(rating), 0) INTO avg_rating
  FROM reviews
  WHERE reviewee_id = user_id;
  
  RETURN ROUND(avg_rating, 2);
END;
$function$
;

CREATE OR REPLACE FUNCTION public.get_user_rating_average(user_uuid uuid, role_filter text DEFAULT NULL::text)
 RETURNS TABLE(overall_avg numeric, owner_avg numeric, walker_avg numeric, total_reviews integer, owner_reviews integer, walker_reviews integer)
 LANGUAGE plpgsql
 SECURITY DEFINER
AS $function$
BEGIN
  RETURN QUERY
  SELECT 
    ROUND(AVG(r.rating)::DECIMAL, 2) as overall_avg,
    ROUND(AVG(CASE WHEN r.reviewed_role = 'owner' THEN r.rating END)::DECIMAL, 2) as owner_avg,
    ROUND(AVG(CASE WHEN r.reviewed_role = 'walker' THEN r.rating END)::DECIMAL, 2) as walker_avg,
    COUNT(*)::INTEGER as total_reviews,
    COUNT(CASE WHEN r.reviewed_role = 'owner' THEN 1 END)::INTEGER as owner_reviews,
    COUNT(CASE WHEN r.reviewed_role = 'walker' THEN 1 END)::INTEGER as walker_reviews
  FROM reviews r
  WHERE r.reviewee_id = user_uuid 
    AND r.status = 'active'
    AND (role_filter IS NULL OR r.reviewed_role = role_filter);
END;
$function$
;

CREATE OR REPLACE FUNCTION public.get_user_review_count(user_id uuid)
 RETURNS integer
 LANGUAGE plpgsql
AS $function$
DECLARE
  review_count INTEGER;
BEGIN
  SELECT COUNT(*) INTO review_count
  FROM reviews
  WHERE reviewee_id = user_id;
  
  RETURN review_count;
END;
$function$
;

CREATE OR REPLACE FUNCTION public.handle_meeting_status_update()
 RETURNS trigger
 LANGUAGE plpgsql
AS $function$
BEGIN
  -- Update the updated_at timestamp
  NEW.updated_at = NOW();
  
  -- Log the status change for debugging
  RAISE NOTICE 'Status change: % -> %', OLD.status, NEW.status;
  
  -- If status is being changed to 'scheduled', ensure it was previously 'pending'
  IF NEW.status = 'scheduled' AND OLD.status != 'pending' THEN
    RAISE EXCEPTION 'Meeting can only be scheduled if it was previously pending. Current status: %', OLD.status;
  END IF;
  
  -- If status is being changed to 'completed', ensure it was previously 'scheduled'
  IF NEW.status = 'completed' AND OLD.status != 'scheduled' THEN
    RAISE EXCEPTION 'Meeting can only be completed if it was previously scheduled';
  END IF;
  
  -- Allow cancellation from any status except completed
  IF NEW.status = 'cancelled' AND OLD.status = 'completed' THEN
    RAISE EXCEPTION 'Cannot cancel completed meetings';
  END IF;
  
  RETURN NEW;
END;
$function$
;

CREATE OR REPLACE FUNCTION public.handle_new_user()
 RETURNS trigger
 LANGUAGE plpgsql
 SECURITY DEFINER
AS $function$
BEGIN
  INSERT INTO profiles (id, email)
  VALUES (NEW.id, NEW.email);
  RETURN NEW;
END;
$function$
;

CREATE OR REPLACE FUNCTION public.set_deletion_schedule_date()
 RETURNS trigger
 LANGUAGE plpgsql
AS $function$
BEGIN
  -- Set scheduled deletion date to 30 days from now
  NEW.scheduled_deletion_date = NOW() + INTERVAL '30 days';
  NEW.updated_at = NOW();
  RETURN NEW;
END;
$function$
;

CREATE OR REPLACE FUNCTION public.update_conversation_timestamp()
 RETURNS trigger
 LANGUAGE plpgsql
AS $function$
BEGIN
  UPDATE conversations 
  SET last_message_at = NOW(), updated_at = NOW()
  WHERE id = NEW.conversation_id;
  RETURN NEW;
END;
$function$
;

CREATE OR REPLACE FUNCTION public.update_deletion_request_updated_at()
 RETURNS trigger
 LANGUAGE plpgsql
AS $function$
BEGIN
  NEW.updated_at = NOW();
  RETURN NEW;
END;
$function$
;

CREATE OR REPLACE FUNCTION public.update_updated_at_column()
 RETURNS trigger
 LANGUAGE plpgsql
AS $function$
BEGIN
    NEW.updated_at = NOW();
    RETURN NEW;
END;
$function$
;

CREATE OR REPLACE FUNCTION public.update_user_settings_updated_at()
 RETURNS trigger
 LANGUAGE plpgsql
AS $function$
BEGIN
  NEW.updated_at = NOW();
  RETURN NEW;
END;
$function$
;



  create policy "Anyone can view dog photos"
  on "storage"."objects"
  as permissive
  for select
  to public
using ((bucket_id = 'dog-photos'::text));



  create policy "Anyone can view profile photos"
  on "storage"."objects"
  as permissive
  for select
  to public
using ((bucket_id = 'profile-photos'::text));



  create policy "Users can delete their own dog photos"
  on "storage"."objects"
  as permissive
  for delete
  to public
using (((bucket_id = 'dog-photos'::text) AND ((auth.uid())::text = (storage.foldername(name))[1])));



  create policy "Users can delete their own profile photos"
  on "storage"."objects"
  as permissive
  for delete
  to public
using (((bucket_id = 'profile-photos'::text) AND ((auth.uid())::text = (storage.foldername(name))[1])));



  create policy "Users can update their own profile photos"
  on "storage"."objects"
  as permissive
  for update
  to public
using (((bucket_id = 'profile-photos'::text) AND ((auth.uid())::text = (storage.foldername(name))[1])));



  create policy "Users can upload dog photos"
  on "storage"."objects"
  as permissive
  for insert
  to public
with check (((bucket_id = 'dog-photos'::text) AND ((auth.uid())::text = (storage.foldername(name))[1])));



  create policy "Users can upload profile photos"
  on "storage"."objects"
  as permissive
  for insert
  to public
with check (((bucket_id = 'profile-photos'::text) AND ((auth.uid())::text = (storage.foldername(name))[1])));



